# Global CLAUDE.md(親ルール・最上位方針)
このファイルは、このリポジトリ全体に適用される「最上位ルール」です。
ClaudeCodeは全ての生成・レビュー・構成提案において、**このファイルを最優先で遵守**してください。

# 0. このファイルの目的
- このレポジトリを**AI活用による学習OS**として運用されるための憲法とする。
- 言語や技術に依らない共通の設計・レビュー・動作方針を定める。  
- ClaudeCode の自動生成をコントロールし、**「骨組みはAI、実装は人間」** の理想的な学習サイクルを作る。  
- プロジェクトの品質を一定に保ちながら、学習の回転率を最大化する。

# 1. レビューポリシー(全技術共通)
ClaudeCodeはコード・構成・設計のレビューを行う際、必ず以下の観点に従うこと。

## 1-1. 設計
- 単一責務(SRP)
- レイヤー分離(UI→アプリ→ドメイン→インフラ)
- 依存方向の健全性（上位が下位に依存しない）

## 1-2. コード品質
- 明確で一貫した命名
- DRY・KISS の徹底
- 不必要な抽象化は禁止
- コメントは必要最小限、自己説明的なコードを優先

## 1-3. セキュリティ
- 入力バリデーション必須
- SQL/NoSQLインジェクション対策
- トークン・認証情報(セッション)の適切な管理
- env の扱い（秘密情報は絶対にコミットしない）

## 1-4. パフォーマンス
- N+1 クエリを避ける
- 無駄なループや重い処理の削減
- キャッシュ活用の可否
- 不必要な I/O を避ける

# 1-5. テスト
- 正常系・異常系・境界値
- ユニット・結合テストの分離
- テストしやすい構造かどうか
- 外部依存はモック化を検討

### 📌 レビュー返答形式（固定）
ClaudeCode のレビューは必ず以下4ブロックで返す：

1. **良い点**  
2. **課題**  
3. **具体的修正例（コード付き）**  
4. **今回の学びポイント**

# 2. ClaudeCodeの基本動作方針
- 必ず「構成案 → 私の承認 → 実行」の順に従う
- **過剰な自動生成は禁止**
- 説明はできるだけ簡潔に(学習効率優先)
- 既存ファイル編集時は **必ず diff を提示し、承認後に編集**  
- 学習目的のため、**ClaudeCode がコードの80〜90%を勝手に埋める行為は禁止**

# 3. 学習OSとしての基本哲学
- 「小さな本番風構成」を高速で回すのが目的  
- 完成度より **回転率**  
- 個別プロジェクトに CLAUDE.md を置かず、**/learning のルール + この憲法** で統一運用  
- 設計思想・判断基準はこのファイルで管理する  
- ClaudeCode の提案は学習効率を最大化することを目的とする

# 4. 禁止事項（ClaudeCode は絶対従うこと）
ClaudeCodeは次をしてはならない:

- 大量自動生成・テンプレ丸ごと書き出し  
- 独断のファイル生成・配置変更  
- 本番向きではない危険構成の生成  
- セキュリティやバリデーション不足のコード生成  
- あいまい・抽象的すぎる説明のみを行うこと  
- 学習目的から外れた過剰な実装

# 5. 自動生成制限ポリシー(重要)
ClaudeCodeは以下を必ず守る:

1. **大量のファイル自動生成は禁止**  
   - 最小限の骨組み・雛形だけ生成する  
2. 私の「OK」なしには生成を開始しない  
3. 既存ファイルの編集は必ず diff を提示  
4. 「全部自動生成しますか？」のような提案は禁止  
5. 生成は常に **必要最小限** に抑える  
6. 実装部分の大半は **私が書くことを前提** にする  
7. ClaudeCode は“提案・補助・レビュー”に徹する

# 6. Git操作ポリシー(超重要)
ClaudeCodeはGitに対し**自動で以下を行ってはならない**:

- commit  
- push  
- pull  
- branch 作成  
- merge / rebase  
- stash 

Gitを触る必要がある場合は:

>「このGitコマンドを手動で実行してください」

と案内するだけに留め、**ClaudeCodeが自動でGitコマンドを実行する行為は禁止する。**

# 7. 言語ポリシー
ClaudeCodeは私に対する質問・確認・ファイル生成前の合意文など、
すべての対話・プロンプト・確認メッセージを**日本語で行うこと**。

- 質問
- 構成案の提示
- 注釈
- レビューコメント

これら全てを日本語で返す。

もし技術使用上で英語が必要な箇所(コード・設定名など)がある場合でも、
説明・確認メッセージは必ず日本語とする。

# 8. アーキテクチャ判断基準

## 全体構造

### UI層 と API層 の分離
- Frontend（Web/Mobile） と Backend（API/Service） は別リポジトリ/別プロジェクト管理を基本とする
- モノレポが必要な場合は `/packages/` ディレクトリを使用して責務を明確に

### データフロー（標準パターン）
```
Entry Point (CLI / API endpoint / Web Handler)
     ↓
Application Layer (ビジネスロジック・オーケストレーション・バリデーション)
     ↓
Domain Layer (エンティティ・ドメインルール・集約)
     ↓
Infrastructure Layer (DB / API Client / File System)
```

**各層の責務**:
- **Entry Point**: リクエスト受け取り、レスポンス返却のみ
- **Application**: 処理の流れ制御、トランザクション管理
- **Domain**: ビジネスルールの実装、バリデーション
- **Infrastructure**: データ取得・永続化、外部連携

### ファイル・ディレクトリ構成（言語別）

#### JavaScript/TypeScript（Next.js, Express など）
```
src/
├── app/              # ページ/ルーハンドラ（Next.js の場合）
├── api/              # API エンドポイント
├── components/       # UI コンポーネント
├── services/         # ビジネスロジック
├── domain/           # エンティティ・バリデーション
├── lib/              # ユーティリティ関数
└── __tests__/        # テスト
```

#### Python
```
src/
├── main.py           # エントリーポイント（CLI/Webサーバ）
├── app/              # ビジネスロジック層
├── domain/           # エンティティ・ドメインルール
├── infrastructure/   # DB/API クライアント
└── __init__.py
tests/
├── unit/             # ユニットテスト
├── integration/      # 統合テスト
└── conftest.py       # pytest 設定
```

#### PHP/Laravel
```
app/
├── Http/Controllers/  # Controller（Entry Point）
├── Services/          # ビジネスロジック層
├── Models/            # Domain エンティティ
├── Repositories/      # Infrastructure（DB アクセス）
└── Requests/          # バリデーション
tests/
├── Unit/              # ユニットテスト
├── Feature/           # 統合テスト
└── TestCase.php       # 基本クラス
```

## テスト戦略

### テストレベルの定義
- **Unit Test**: 単一の関数/メソッド/クラスをテスト（外部依存はモック化）
- **Integration Test**: 複数層の連携をテスト（DB はテスト用に隔離）
- **E2E Test**: 実際のワークフロー全体をテスト（大型プロジェクト・Web UI テストのみ）

### テスト対象の優先順位
1. ドメインロジック（ビジネスルール）
2. API エンドポイント・ハンドラ
3. リポジトリ/DB クエリ（データ層）
4. ユーティリティ関数

### テストしなくてもよい箇所
- フレームワークの標準機能（Rails の自動ルーティング等）
- 外部ライブラリの検証（すでにテストされている）
- UI レイアウト（スナップショットテストは過度）

## セキュリティレビューチェックリスト

新規プロジェクト・大型変更時に必ず確認:

```
入力バリデーション
□ ユーザー入力は全て バリデーション・サニタイズ対象
□ API リクエストボディ・クエリパラメータをチェック
□ ファイルアップロード時はサイズ・形式を制限

SQLインジェクション / NoSQL インジェクション
□ SQL/NoSQL クエリはパラメータ化クエリを使用
□ ORM を使用している場合、raw クエリは最小化

認証・認可
□ API キー / Session Token は env に隔離
□ JWT の署名検証が実装済み
□ ユーザー認証情報（password）は絶対にログに出力しない

CORS / CSRF / XSS（Web API の場合）
□ CORS は必要な origin のみを許可
□ CSRF トークン実装（フォーム送信時）
□ XSS 対策：テンプレートエンジンは自動エスケープ対応

ファイル操作
□ アップロードファイルはウイルススキャン検討
□ ファイルパス traversal 対策（../../../ 等）
□ アップロード先は web root の外に配置

秘密情報管理
□ API key / 認証情報は .env に隔離
□ .env ファイルは .gitignore に含める
□ Git 履歴から秘密情報がリークしていないか確認

エラーハンドリング
□ エラーメッセージに内部情報を含めない
□ スタックトレースを本番環境に出力しない
□ ログには十分な情報を含める（デバッグ用）
```

# 9. プロジェクト完成の定義

学習用プロジェクトが「完成」とみなされる条件:

- [ ] README.md に目的・実行方法が明記されている
- [ ] 最初のテストが1つ以上実行でき、パスしている
- [ ] src/ 以下に最小限の実装が存在する（ダミーコードは不可）
- [ ] セキュリティレビュー対象項目をチェック済み
- [ ] 依存ライブラリのバージョンが明記されている（package.json / requirements.txt など）
- [ ] Git コミットメッセージが日本語で意図が明確
- [ ] `.env.example` が存在する（秘密情報が必要な場合）

「完成度」より「回転率」を優先するため、上記を満たせばプロジェクト化完了。
その後の実装詳細・最適化は別途学習のテーマとする。

# 10. このレポジトリの目的
- 学習ログを資産化し、Gitで管理する
- ClaudeCode との自己強化ループを作る 
- 言語・フレームワーク問わず高速学習できる環境を構築 
- 転職ポートフォリオとしても活用する

以上のルールをこのレポジトリにおける**絶対的な最上位ルール（憲法）** とする。